<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" http-equiv="encoding">
  <meta http-equiv="content-language" content="ja">
  <title>cityEmissions</title>

  <script src="lib/d3.v4.min.js"></script>
  <!--<script src="lib/d3-selection-multi.v0.4.min.js"></script>-->
  <script src="lib/d3-tip.js"></script>

  <!--https://github.com/d3/d3-geo-projection-->
  <script src="https://d3js.org/d3-array.v1.min.js"></script>
  <script src="https://d3js.org/d3-geo.v1.min.js"></script>
  <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
  <!--https://bl.ocks.org/mbostock/3711652-->
  <script src="lib/topojson.v1.min.js"></script>

  <!-- jquery -->
  <script src="lib/jquery.min.js"></script>

  <!-- bootstrap -->
  <script src="lib/bootstrap.min.js"></script>
  <link href="lib/bootstrap.min.css" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <!-- custom -->
  <link href="style.css" rel="stylesheet">
  <script src="aux_fns.js"></script>
  <script src="globalvars.js"></script>

</head>
<body>

  <div class="container">

    <!-- header row -->
    <div class="row">
      <div class="col-lg-12">entete</div>
    </div> <!-- ./header row -->

    <!-- info text row -->
    <div class="row">
      <div class="col-lg-6" id="infoText" style="text-align: left;">
        Hover over a city on the world map to the corresponding city <a href="http://www.ghgprotocol.org/sites/default/files/ghgp/standards/GHGP_GPC_0.
pdf" target="_blank"> emissions </a> data, either per capita (default) or per unit of Gross Domestic Product at Purchasing Power Parity rates. Note that the city source dataset does not have the same number of cities in different
      </div>
      <div class="col-lg-6" id="infoText" style="text-align: left;">
       regions of the world. We present here city emissions grouped per continent, although different lifestyles and energy use make city emissions strongly different within a continent.
      </div>
      <ul class="nytg-sort" style='position: absolute; left: 1250px; top: 119px;'>
        <li id="resetButton">Reset</li>
      </ul>

      <div class="col-lg-4" ></div>
    </div> <!-- ./row 1 -->
  
    <!-- row for map and city card -->
    <div class="row">
      <div class="col-lg-12">
        <div id="map"></div>

      </div>

      <!--<div class="col-lg-4" id="displayGHGstats">
        <div id="ghgDelta"></div><br>
        <div id="ghgDeltaReason"></div>
        <div id="ghgStory"></div>
      </div> -->

    </div> <!-- ./map and city card row -->

    <!-- row 3 -->
    <div class="row">
      <div class="col-lg-6">
          <div id="barChartLegendLabel">Colour bars by: 
            <select id="d3-dropdown">
              <option value="methodology">Protocol</option>
              <option value="population density">population density</option>
              <!--<option value="gas price">gas price</option>
              <option value="diesel price">diesel price</option>
              <option value="HDD 15.5C">HDD 15.5C</option>
              <option value="CDD 23C">CDD 23C</option>
              <option value="change in emissions">change in emissions</option>
              <option value="low BUA %">low BUA % (2014)</option>
              <option value="high BUA %">high BUA % (2014)</option>
              <option value="Congestion rank (INRIX)">Congestion rank (INRIX)</option>
              <option value="Congestion rank (TomTom)">Congestion rank (TomTom)</option>
              <option value="CIMI ranking (IESE)">CIMI ranking (IESE)</option> -->
            </select>          
          </div>

        
      </div>

      <div class="col-lg-6" id="cityCardTitle" style="text-align: left;">Recent emission changes from city reports </div>
    </div> <!-- ./row 3 -->

    <!-- row 4 -->
    <div class="row">

      <div class="col-lg-6">
        <!--barChart legend-->
        <div class="row">
          <div id="barChartCaption"></div>
          <ul class="nytg-sort" id="emissionsToggleButton">
              <li id="gdpButton">per GDP</li>
          </ul>
          <ul class="nytg-sort" style='position: absolute; left: 473px; top: 0px;'>
              <li id="reorderButton" style="display: none;">Re-order</li>
          </ul>


          <div id="barChartLegend"class="col-lg-12">
            <svg></svg>
          </div>
        </div>

        <!--barChart sub-rows-->
        <div class="row">
          <div class="col-lg-12">
            <div class="barChartTitle">Europe &#183; Asia</div>
            <div id="barChart_Eurasia"></div>
          </div>
        </div>

        <div class="row">
          <div class="col-lg-9">
            <div class="barChartTitle">USA</div>
            <div id="barChart_USA"></div>
          </div>
          <div class="col-lg-3">
            <div class="barChartTitle">Canada</div>
            <div id="barChart_Can"></div>
          </div>
        </div> <!-- ./sub-row USA chart -->


        <div class="row">
          <div class="col-lg-3">
            <div class="barChartTitle">Aus &#183; NZ</div>
            <div id="barChart_Oceania"></div>
          </div>
          <div class="col-lg-3">
            <div class="barChartTitle">Africa</div>
            <div id="barChart_Africa"></div>
          </div>
          <div class="col-lg-6">
            <div class="barChartTitle">Latin America</div>
            <div id="barChart_LatinAmer"></div>
          </div> 
        </div> 
        <div class="row">city</div>

      </div> <!-- ./col-lg-7 -->

      <div class="col-lg-6">
        <div id="cityCardName" style="text-align: left;"></div>

        <div id="cityCardChange" style="text-align: left;"></div>

        <div id="cityCardChangeReason" style="text-align: left;"></div>

      </div> <!-- ./col-lg-4 -->

      
    </div> <!-- ./row 4-->

    <footer class="row">
      Pied de page
    </footer>

</div>  <!-- ./container -->


<script>

// ----------------------------------------------------
// Setup
// ----------------------------------------------------

var container = d3.select("body").append("div")
    .style("width",width);

// Leaflet map variables
// ---------------------------------
// var width = 700,
//     height = 350; //400;

var pointRadius = 5;

var cityName_array = [];

// Define the div for the gdpButton tooltip
var div = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

// ----------------------------------------------------
// Code
// ----------------------------------------------------

// ----------------------------------------------------
// Buttons
// ----------------------------------------------------
//Attribute dropdown button
d3.select("select")
  .on("change",function(d){
    attrFlag = d3.select("#d3-dropdown").node().value;
    // console.log("attrFlag: ",attrFlag);

    rect_colourArray = choose_colourArray[attrFlag];

    d3.select("#barChartLegend").selectAll("rect")
    .attr("fill", function (d, i) {
      return rect_colourArray[i];
    });

    emissionsBarChart("groupEurope", "#barChart_EU");
    emissionsBarChart("groupUSA", "#barChart_USA");
    emissionsBarChart("groupCan", "#barChart_Can");
    emissionsBarChart("groupOceania", "#barChart_Oceania");
    emissionsBarChart("groupAfrica", "#barChart_Africa");
    emissionsBarChart("groupAsia", "#barChart_Asia");
    emissionsBarChart("groupLatinAmer", "#barChart_LatinAmer");
    
})

//barChart buttons
//select emissions to display: scaled by capita or by GDP-PPP
d3.select("#gdpButton")
  .on("click", function() {
    div.style("opacity", 0); //clear tooltip
    
    var buttonText = (d3.select(this).text() === label_dataPerGDP) ?
                      label_dataPerCap : label_dataPerGDP;

    d3.select(this).text(buttonText);

    //Plot emissions bar charts for each geo group    
    emissionsBarChart("groupEurope", "#barChart_EU");
    emissionsBarChart("groupUSA", "#barChart_USA");
    emissionsBarChart("groupOceania", "#barChart_Oceania");
    emissionsBarChart("groupAfrica", "#barChart_Africa");
    emissionsBarChart("groupAsia", "#barChart_Asia");
    emissionsBarChart("groupLatinAmer", "#barChart_LatinAmer");

    //(de-)activate reorder button if "Scope1/capita" is being displayed
    var reorderState = (buttonText === label_dataPerCap) ? "block" : "none";
    d3.select("#reorderButton").style("display", reorderState);
     
  })
  .on("mouseover", function () {
    var dictText = emissionsToggleDict[d3.select(this).text()];

    div.style("opacity", 1); //tooltip
    div.html(function () { return dictText; })
       .style("left", 820 + "px")
       .style("top", -940 + "px");
  })
  .on("mouseout", function () { div.style("opacity", 0); });

// Re-order barChart of emissions/GDP-PPP according to emissions/capita
d3.select("#reorderButton")
  .on("click", function() {
    // Toggle re-order button text for each click
    var buttonText = (d3.select(this).text() === "Re-order") ?
                      "orig order" : "Re-order";
    d3.select(this).text(buttonText);

    //Re-order Scope1/GDP according to Scope1/capita
    emissionsBarChart("groupEurasia", "#barChart_Eurasia");
    emissionsBarChart("groupUSA", "#barChart_USA");
    emissionsBarChart("groupOceania", "#barChart_Oceania");
    emissionsBarChart("groupAfrica", "#barChart_Africa");
    // emissionsBarChart("groupAsia", "#barChart_Asia");
    emissionsBarChart("groupLatinAmer", "#barChart_LatinAmer");
     
  })
  .on("mouseover", function () {
    var tooltip_text = (d3.select(this).text() === "Re-order") ? 
                    "Re-order cities according to decreasing emissions <b>per capita</b>." :
                    "Back to original order in decreasing emissions per GDP-PPP."
    div.style("opacity", 1);
    div.html(tooltip_text)
        .style("left", 900 + "px")
        .style("top", -940 + "px");
  })
  .on("mouseout", function () { div.style("opacity", 0); });

// // Map reset button
// d3.select("#resetButton")
//     .on("click", resetMap);

// function resetMap() {
//     console.log("resetmap")
// }

// ----------------------------------------------------
// Main Code
// ----------------------------------------------------

//Find data range extent for each dim (to be used to discretize into colour values)
d3.tsv("data/cityApp_attributes.tsv", function(ghg) {  
  dimExtentDict = {
    "methodology": d3.extent(ghg, function (d) {return d['MethodNum'];}),
    "population density": d3.extent(ghg, function (d) {return +d["pop to use"]/d["area [km2] (external)"];})
  }
}) //end read tsv
//console.log("dimExtentDict: ", dimExtentDict["methodology"])

//barChart legends
fn_appendColourBar();
fn_appendRegionalLine();

// d3.csv("data/Creutzig2014_dataset_wb.csv", function(ghg) {
d3.tsv("data/cityApp_attributes.tsv", function(ghg) {
  //console.log("ghg read: ", ghg)

  setupData(ghg);
  drawMap();
  emissionsBarChart("groupEurasia", "#barChart_Eurasia");
  emissionsBarChart("groupUSA", "#barChart_USA");
  emissionsBarChart("groupCan", "#barChart_Can");
  emissionsBarChart("groupOceania", "#barChart_Oceania");
  emissionsBarChart("groupAfrica", "#barChart_Africa");
  // emissionsBarChart("groupAsia", "#barChart_Asia");
  emissionsBarChart("groupLatinAmer", "#barChart_LatinAmer");
});

// ----------------------------------------------------
// Main Functions
// ----------------------------------------------------

// d3js World Map
//------------------
var width = 1000,
    height = 360; //cut off antarctica  //400;

function drawMap() {
  // Map reset button
  d3.select("#resetButton")
      .on("click", resetMap);

  //https://bl.ocks.org/mbostock/db6b4335bf1662b413e7968910104f0f
  var zoom = d3.zoom()
    .scaleExtent([1, 40])
    //.translateExtent([[-100, -100], [width + 90, height + 100]])
    .on("zoom", zoomed);

  //https://bl.ocks.org/mbostock/3711652
  // var mapHeight = 410;

  var options = [
    {name: "Natural Earth", projection: d3.geoNaturalEarth()}
  ];

  options.forEach(function(o) {      
    o.projection.rotate([0, 0]).center([40, 0]);
  });

  var projection = options[0]
              .projection
              .scale(171) //141
              .translate([width/1.655, height/1.67  ]);  //1.633, 1.69

  var path = d3.geoPath()
      .projection(projection)
      .pointRadius([3]);

  var graticule = d3.geoGraticule();

  var svg = d3.select("#map").append("svg")
      .attr("width", width)
      .attr("height", height)

  svg.append("defs").append("path")
    .datum({type: "Sphere"})
    .attr("id", "sphere")
    .attr("d", path);

  svg.append("use")
    .attr("class", "stroke")
    .attr("xlink:href", "#sphere");
    
  svg.append("path")
    .datum(graticule)
    .attr("class", "graticule")
    .attr("d", path);

  //draw bottom line of map
  svg.append("g").selectAll("line")
      .data([0])
      .enter().append("line")
      .attr("class", "line")
      .style("stroke", "#555")
      .style("stroke-width", "1.2px")
      .attr("x1", 85)
      .attr("y1", 359)
      .attr("x2", 915)
      .attr("y2", 359);

  //draw top line of map
  svg.append("g").selectAll("line")
      .data([0])
      .enter().append("line")
      .attr("class", "line")
      .style("stroke", "#555")
      .style("stroke-width", "1.2px")
      .attr("x1", 163)
      .attr("y1", 0)
      .attr("x2", 839)
      .attr("y2", 0);      

 
  d3.json("geojson/world_countries.json", function(error, world) {
    if (error) throw error;
   
    d3.json("geojson/cities_edited.geojson", function(error, cities) {
      if (error) throw error;

      //world countries
      svg.append("g")
          .attr("class", "countries")
        .selectAll("path")
          .data(world.features)
        .enter().append("path")
          .attr("d", path)
          .attr("id", function (d) {
            mapName = d.properties.name.replace(/\s/g, '_');
            return "map" + mapName;
          })
          .style("fill", "#2B292E") //#000, "#d9d9d9"
          .style('stroke', '#555')  //#555
          .style('stroke-width', 1.5)
          // tooltips
            .style('stroke-width', 1);
            // .on('mouseover',function (d) {
            //   //tip.show(d);
            //   d3.select(this)
            //     // .style("opacity", 1)
            //     .style("stroke","#CBBF31")
            //     .style("stroke-width",3);
            // })
            // .on('mouseout', function (d) {
            //   // tip.hide(d);
            //   //highlightElements(idName, d.country);
            //   d3.select(this)
            //     // .style("opacity", 0.8)
            //     .style("stroke","white")
            //     .style("stroke-width",0.3);
            // });
      
      // City markers from geojson file     
      svg.selectAll('path')
          .data(cities.features)
          .enter().append('path')
          .attr('d', path)
          .attr("id", function (d, i) {
            return "city" + format_idName(d.id);
          })
          .attr("class", "worldcity")
          .style("fill", function (d) {

            if (data_GHG.find(x => x.city === d.id)) {              
              return regionColourMap[data_GHG.find(x => x.city === d.id).region];
            }
            else return "none";
          })
          .style("stroke", function (d) {
            if (data_GHG.find(x => x.city === d.id)) return "#555";
            else return "none";  
          })
          .on("mouseover", function (d) {
            highlightElements(format_idName(d.properties.city));
          })
          .on('mouseout', function (d) {
            resetElements();
          });



    }); // ./inner d3.json
  }); // ./outer d3.json
  
  svg.call(zoom);

  function zoomed() {
  
    // path.pointRadius([0.1])
    // console.log("path: ", path.pointRadius())

    svg.attr("transform", d3.event.transform);
    

    // gX.call(xAxis.scale(d3.event.transform.rescaleX(x)));
    // gY.call(yAxis.scale(d3.event.transform.rescaleY(y)));
  }


  function resetMap() {
    svg.transition()
      .duration(750)
      .call(zoom.transform, d3.zoomIdentity);
  } 
  


} // ./drawMap()

function highlightElements(idName) {
  // clear any previous story first
  d3.select("#ghgStory").text("");

  var selectedCity = data_GHG.find(x => x.idName.includes(idName));
  // console.log("idName: ", idName)
  // console.log("tmp: ", selectedCity)

  d3.select("#cityCardName")
    .text(selectedCity.city)
    .style("font-size", "20px")
    .style("text-align", "left");

  d3.select("#cityCardChange")
    .text("Change in emissions from previous year: " + selectedCity['change in emissions'])
    .style("font-size", "16px")
    .style("text-align", "left");

  d3.select("#cityCardChangeReason")
    .text("Reason: " + selectedCity['reason for change'])
    .style("text-align", "left");
      
  // if (countryName === "United Kingdom") countryName = "England";
  // countryName = countryName.replace(/\s/g, '_');

  //Clear Previous
  //--------------
  resetElements();

  //Highlight Current
  //-----------------
  d3.select("#bar" + idName)
    .style("stroke", "#363636"); 

  d3.selectAll(".bar:not(#bar" + idName + ")")
    .style("fill-opacity", 0.3); 

  d3.selectAll(".node:not(#node" + idName + ")")
    .style("fill-opacity", 0.1)
    .style("stroke-opacity", 0.1);
  
  d3.selectAll(".worldcity:not(#city" + idName + ")")
    .style("fill-opacity", 0.1)
    .style("stroke-opacity", 0.1);
  d3.selectAll(".countries").selectAll("path").style("opacity", 0.1);
  d3.select("#city" + idName)
    .attr("stroke", "black")
    .attr("stroke-width", 2);

  

} // ./highlightElements()

// Update region text when hovering over worldmap city
// function updateRegionLabel(region) {
//   d3.select("#regionLabel" + region).text(regionLabel_dict[region])
//     // .style("margin-left", "60px");
// }

function emissionsBarChart(geogroup_name, geogroup_id) {
  dimExtent = [dimExtentDict[attrFlag][0], dimExtentDict[attrFlag][1]]

  // Remove any previous bar chart
  d3.select(geogroup_id).select("svg").remove();
  
  // barChart caption in #barChartCaption div
  this_dim = (d3.select("#gdpButton").text() === label_dataPerGDP) ?
                      label_dataPerCap : label_dataPerGDP;
  // d3.select("#barChartCaption").text(this_dim + " " + dimUnits[this_dim]
  //   + " emissions grouped by world region");
  if (this_dim === label_dataPerCap) {
    d3.select("#barChartCaption").text("Per capita emissions " + dimUnits[this_dim]);
  } else {
    d3.select("#barChartCaption").text("Emissions per unit of Gross Domestic Product " 
      + dimUnits[this_dim]);
  }

  //https://bl.ocks.org/seemantk/ec245e1f4e824e685982dd5d3fbb2fcc
  var margin = {top: 0, right: 0, bottom: 0, left: 40};
  if (geogroup_name === "groupOceania" || geogroup_name === "groupAfrica"
    || geogroup_name === "groupLatinAmer") {
    margin = {top: 0, right: 0, bottom: 0, left: 100};
  } else if (geogroup_name === "groupEurasia") {
    margin = {top: 0, right: 0, bottom: 0, left: 2};
  }
  var width = 700 - margin.left - margin.right,
      height = 250 - margin.top - margin.bottom;

  //Extract scaled emissions data for given region
  //Omit cities for which GDP-PPP is missing
  if (geogroup_name === "groupEurasia") {
    //Extract data by region
    ghg_europe = sortByRegion("groupEurope");
    ghg_asia = sortByRegion("groupAsia");

    //Sort columns in each region
    ghg_europe.sort((a, b) => d3.descending(a[this_dim], b[this_dim]));
    ghg_asia.sort((a, b) => d3.descending(a[this_dim], b[this_dim]));

    //Concatenate Europe and Asia with a gap in between
    var emissions_scaled = ghg_europe
      .concat([{ "city":"gap",  "region":"groupEurasia",
                 "per capita":0, "per GDP": 0 }])
      .concat(ghg_asia);

  }
  else {
    emissions_scaled = sortByRegion(geogroup_name, this_dim);
    //Sort columns
    emissions_scaled.sort((a, b) => d3.descending(a[this_dim], b[this_dim]));
  }

  // // Get city order of Scope/capita
  // if (d3.select("#reorderButton").text() === "orig order") {
  //   emissions_scaled = fn_reorderByEmissionsPerCapita(geogroup_name, emissions_scaled);
  // } // end button text check

  var x = d3.scaleBand()
            .rangeRound([0, width], .1)
            .paddingInner(0.1);

  var y = d3.scaleLinear()
            .range([height, 0]);

  var xAxis = d3.axisBottom()
    .scale(x);

  var yAxis = d3.axisLeft()
    .scale(y)
    //.orient("right") //d3v3
    // .ticks(5, "%")
    // .ticks(5)
    // .tickPadding(2)
    .tickFormat(function(d) {
      return this_dim === label_dataPerGDP ? formatDecimalk(d) : d;
    });


  //https://mathisonian.com/writing/easy-responsive-svgs-with-viewbox
  //https://jsfiddle.net/fh5kxv3k/
  var aspectRatio = '660:241';
  var viewBox = '0 0 ' + aspectRatio.split(':').join(' ');

  //chart sizes are ok, but text is stretched. This is a limitation of viewBox for charts. See:
  //https://medium.com/@maheshsenni/responsive-svg-charts-viewbox-may-not-be-the-answer-aaf9c9bc4ca2
  //http://www.cagrimmett.com/til/2016/04/26/responsive-d3-bar-chart.html
  //https://bl.ocks.org/veltman/5cd1ba0b3c623e7b5146

  //Fit barCharts responsively using viewBox
  //NB: viewBox stretches text labels as well, so they must be fixed later by adjusting the scale
  // if (geogroup_name === "groupUSA") my_width ="75%";
  // else if (geogroup_name === "groupCan") my_width ="25%";
  // else my_width = "100%";
  if (geogroup_name === "groupLatinAmer") my_width = "80%";
  else if (geogroup_name === "groupOceania") my_width = "70%";
  else if (geogroup_name === "groupAfrica") my_width = "70%";
  else my_width = "100%";
  var svgBarChart = d3.select(geogroup_id).append("svg").attr("class", "barSVG")
    .attr('width', my_width)
    .attr('height', 125) // height)
    .attr('viewBox', viewBox)
    .attr('viewBox', '0 0 ' +  ( width + margin.left + margin.right ) + ' ' + ( height  + margin.top + margin.bottom ) )
    .attr('preserveAspectRatio', 'none')
    // .attr("width", width + margin.left + margin.right)
    // .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  // This label gets stretched differently depending on scaling of viewBox  
  // var barRegionLabel = svgBarChart.append("g")
  //         .append("text")
  //         .attr("class", "barChartRegionLabel")
  //         .text("For now");

  x.domain(emissions_scaled.map(function (d) {
    return d.city;
  }));
  y.domain([0, d3.max(emissions_scaled, function(d) {

    // console.log("d[this_dim]: ", d[this_dim])

    if (this_dim === label_dataPerCap) {
      if (geogroup_name === "groupEurope" || geogroup_name === "groupEurasia" ||
        geogroup_name === "groupUSA" || geogroup_name === "groupCan") same_max = 20;
      else  same_max = 6;      
    } else {
      same_max = d[this_dim];
    //   if (geogroup_name === "groupAfrica") same_max = 750000;
    //   else same_max = 370000;
    }

    return same_max;
    // return d[this_dim];

  })]);

  // //https://bl.ocks.org/veltman/5cd1ba0b3c623e7b5146
  // var myscale = width / container.node().getBoundingClientRect().width;
  // console.log('myscale: ', myscale)

  // Define the div for the barChart rect tooltip
  var div = d3.select("body").append("div")
    .attr("class", "tooltip-bar")
    .style("opacity", 0);

  //bars
  svgBarChart.append("g").selectAll(".bar")
      .data(emissions_scaled)
      .enter().append("rect")
      .attr("class", "bar")
      .attr("id", function (d) {
        idName = format_idName(d.city);
        return "bar" + idName;
      })
      .attr("x", function (d) { return x(d.city); })
      .attr("width", x.bandwidth())
      .attr("y", function (d, i) { return y(d[this_dim]); })
      .attr("height", function(d) { return height - y(d[this_dim]); })
      // .attr("fill", function (d) {
      //   //output the discretized colour according to selected attribute
      //   return fn_discretize(attrFlag, dimExtent, d);
      // })
      .on("touchmove mousemove", function (d) {
        fn_enlargeName(geogroup_name, d.city);

        idName = format_idName(d.city);
      
        highlightElements(idName);

        var tipx = 20;
        var tipy = -120;
        div.style("opacity", 1);
        div.html(formatDecimalSci(d[this_dim]) + " " + dimUnits[this_dim])
          .style("left", d3.event.pageX + tipx + "px")
          .style("top", d3.event.pageY + tipy + "px");

      })
      .on("mouseout", function (d) {
        resetElements();
        
        d3.select("#tick" + idName).text(function (d) { return fn_abbr(d); })
          .style("font-size", "10px")
          .attr("fill", colour_labels);

        div.style("opacity", 0);
      });

  //colour the bars and legend rects according to attrFlag selected
  //also dislay correct legend text for each rect
  //svgBarChart = d3.select("#barChart_EU .barSVG")
  svgBarChart.selectAll("rect").attr("fill", function (d) {
        //output the discretized colour according to selected attribute
        return fn_discretize(attrFlag, dimExtent, d);
      });

  //x-axis
  svgBarChart.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisTop(x))
      .selectAll("text")
      .text(function (d) { return fn_abbr(d); })
      .attr("id", function (d) {
        idName = format_idName(d);
        return "tick" + idName;
      })
      .attr("y", -3)
      .attr("x", 7)
      .attr("dy", "12px")
      .attr("transform", function (d) {
        if (d != "gap") {
          if (geogroup_name === "groupEurasia") {
            //xscale=1; yscale=1; 
            rot=-45;
            xtrans=165; ytrans = -155;
           } else {
            rot = -90;
            xtrans = 0; ytrans = 0;
           }

          return "rotate(" + rot + ")" +
                   "translate(" + xtrans + " " + ytrans + ")" ;
         
          // return "scale(" + xscale + " " + yscale + ")" + "rotate(" + rot + ")" +
          //         "translate(" + xtrans + " " + ytrans + ")" ;
        }

      })
      .style("text-anchor", "start")  //"middle"
      .style("fill", function (d) {
        // return "#000000";//colour_labels;
        if (d.includes("gap")) return "#fff";
        else return "#000";
      })
      .on("touchmove mousemove", function (d) {
        fn_enlargeName(geogroup_name, d);
      })
      .on("mouseout", function (d) {
        d3.select("#tick" + idName).text(function (d) { return fn_abbr(d); })
          .style("font-size", "10px");
      });


  //y-axis
  svgBarChart.append("g")
      .attr("class", "y axis")
      //.call(yAxis)
      .call(d3.axisRight(y).ticks(5))
      .selectAll("text")  
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em");

  //-----------------------------------------------------------------------------------------
  //Visual fixes
  //1. Enlarge barChart y-axis tick labels then fix position

  //https://stackoverflow.com/questions/27405377/iterate-over-already-created-nodes-in-d3js
  // var yfactor = 1.5;
  // d3.select(geogroup_id).select('.barSVG').selectAll('g .y.axis .tick') //get all the nodes
  //   .each(function (d) {
  //     //x scale factor
  //     var xfactor = xScaleFactor[geogroup_id];

  //     orig_ypos_str = this.attributes.transform.value.toString();

  //     orig_ypos = parseFloat(orig_ypos_str.split(",")[1].split(")")[0]);
  //     new_ypos = orig_ypos/yfactor;

  //     d3.select(this)
  //       .attr("transform", "scale(" + xfactor + " " + yfactor + ")" 
  //                         + "translate(" + 0 + "," + new_ypos + ")" );
 
  //   });

  // ./Visual Fixes/----------------------------------------------------------------------------------

  

  // Plot regional avg emissions [tCO2/capita] as a line over each barChart
  //fn_appendRegionalMeans(svgBarChart, geogroup_name, this_dim, emissions_scaled, x, y);


} // ./fn emissionsBarChart()


</script>
</body>
</html>