<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" http-equiv="encoding">
  <meta http-equiv="content-language" content="ja">
  <title>cityEmissions</title>

  <script src="lib/d3.v4.min.js"></script>
  <!--<script src="lib/d3-selection-multi.v0.4.min.js"></script>-->
  <script src="lib/d3-tip.js"></script>

  <!--https://github.com/d3/d3-geo-projection-->
  <script src="https://d3js.org/d3-array.v1.min.js"></script>
  <script src="https://d3js.org/d3-geo.v1.min.js"></script>
  <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
  <!--https://bl.ocks.org/mbostock/3711652-->
  <script src="lib/topojson.v1.min.js"></script>

  <!-- jquery -->
  <script src="lib/jquery.min.js"></script>

  <!-- bootstrap -->
  <script src="lib/bootstrap.min.js"></script>
  <link href="lib/bootstrap.min.css" rel="stylesheet">

  <!-- custom -->
  <link href="style.css" rel="stylesheet">
  <script src="aux_fns.js"></script>
  <script src="globalvars.js"></script>

  <style>
   
    div.vtooltip {
      position: absolute;
      text-align: center;
      width: 60px;
      height: 30px;
      padding: 2px;
      font: 12px sans-serif;
      background: #C5E0DC;  /*lightsteelblue;*/      
      border: 0px;
      border-radius: 8px;
      pointer-events: none;
    }
    div.rtooltip {
      position: absolute;
      text-align: left;
      width: 190px;
      height: 110px;
      padding: 2px;
      font: 8px;
      background: #EEE4C5;
      border: 0px;
      border-radius: 8px;
      pointer-events: none;
    }
    #infoText {
      margin: 20px;
    }

    /* map */
    #sphere {
      padding-top: 0px;
    }
    /* #map {*/
    /*  width: 800px; /*100%;*/
    /*  height: 400px; /*100%;*/
    /*} */
    .stroke {
      fill: none;
      stroke: #000;
      stroke-width: 1px;
    }
    .fill {
      fill: #fff;
    }
    .graticule {
      fill: none;
      stroke: #777;
      stroke-width: .5px;
      stroke-opacity: .5;
    }
    .land {
      fill: #222;
    }
    .boundary {
      fill: none;
      stroke: #fff;
      stroke-width: .5px;
    }

    /* bar chart */
    #ghgBarChart {
      position: absolute;
      left:820px;
      top:100px;
    }
    .barChartRegionLabel {
      fill: #636363;
    }
    .axis {
      font: 10px sans-serif;
    }
    .axis path,
    .axis line {
      /*fill: none;*/
      stroke: #000;
      shape-rendering: crispEdges;
    }
    .x.axis path {
      display: none;
    }

    /*Stats table*/
    #displayStats {
      position: absolute;
      margin-top: -40px;
      margin-left: 1505px;
    }
    #displayGHGstats {
      position: absolute;
      margin-top: 4px;
      margin-left: 819px;
    }
    

    /* similarity map */
    #cb {
      width: 100px; /*100%;*/
      height: 100px; /*100%;*/
    }
    #cb_label {
      width: 150px; /*100%;*/
      margin-left: 110px;
      /*margin-top: 25px; */
    }
    .d3-tip {
      line-height: 1;
      padding: 6px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      border-radius: 4px;
      font-size: 14px;
    }
    /*#mapSim {
      width: 800px;
      height: 400px;
    }*/
    ellipse {
      fill: none;
      stroke: #C5E0DC;
      stroke-width: 2;
      stroke-linejoin: round;
    }
    .textLabels {
      fill: #636363;
    }
    .nodeText, .nodeTextSelected {
      fill: #636363;
      font-size: 11px;
      font-style: italic;
    }
    /* ./similarity map */

    
    #ghgStory {
      margin-top: 20px;
    }
    td, th {
      padding: 1px 4px;
      font-size: 14px;
    }

  </style>
</head>
<body>

<div class="row">
  <div id="infoText"></div>
</div>

<div class="row">
  <!--d3js map-->
  <div class="col-xs-5">    
    <div id="map"></div>
    <ul class="nytg-sort" style='position: absolute; left: 0px; top: 6px;'>
      <li id="resetButton">Reset</li>
    </ul>
  </div>

  <div id="ghgBarChart" class="col-xs-4">
    <div id="regionLabel"><h4>GHG/capita emissions grouped by world region</h4></div>
    <ul class="nytg-sort" style='position: absolute; left: 463px; top: 6px;'>
      <li id="barButton">GHG/GDP</li>
    </ul>
  </div>
  <div id="displayStats" class="col-xs-3">

  </div>

</div>


<div class="row">
  <div style="margin-left:15px;width:550px;padding-top:10px;">Similarity Map: this diagram groups cities by <a href="help.html" target="_blank">similarity</a> across multiple factors.</div>
</div>

<div class="row">
  <!--Similarity voronoi map-->
  <div id="mapSim" class="col-xs-5">    
    <svg></svg>
  </div>

  <div id="displayGHGstats" class="col-xs-5">
    <div id="ghgTable"></div>
    <div id="ghgDelta"></div><br>
    <div id="ghgDeltaReason"></div>
    <div id="ghgStory"></div>
  </div>

</div>

<div class="row" style=>
   <!--colourbar-->
  <div id="cb_label" class="col-xs-1"><h4>GHG/capita</h4></div>
  <div id="cb" class="col-xs-5">    
    <svg></svg>
  </div>
</div>

<div class="row">
  <div id="selectDim">
    <form>
      <label>Overlay:  <input type="radio" name="dataset" value="GHG/capita" checked> GHG/capita</label>
      <label><input type="radio" name="dataset" value="GHGe intensity 2004">GHGe intensity (2004)</label>
      <label><input type="radio" name="dataset" value="GHGe intensity 2009">GHGe intensity (2009)</label>
      <label><input type="radio" name="dataset" value="region"> Region</label><br>
      <label>Classified by: <input type="radio" name="dataset" value="population"> Pop</label>
      <label><input type="radio" name="dataset" value="population density"> Pop density</label>
      <label><input type="radio" name="dataset" value="GDP/capita"> GDP/cap</label>
      <label><input type="radio" name="dataset" value="diesel price"> Diesel price</label>
      <label><input type="radio" name="dataset" value="gas price"> Gas price</label>
      <label><input type="radio" name="dataset" value="HDD 15.5C">HDD 15.5C</label>
      <label><input type="radio" name="dataset" value="CDD 23C">CDD 23C</label>
      <label><input type="radio" name="dataset" value="urban ratio">Urban ratio</label>
      <label><input type="radio" name="dataset" value="commerce index">Commerce index</label>
      <label><input type="radio" name="dataset" value="household size">HH size</label>
    </form>
  </div>
</div>

<script>

// ----------------------------------------------------
// Setup
// ----------------------------------------------------


// Global vars
// -----------
// var data_noGHG = [];

var voronoiLineColour = d3.rgb(249,236,219); //"#F1D4AF"; //"#E5C688"; //"#CBBCA6"; //"tomato";
var voronoiCircleColour = "#E2D373";
var voronoiHighlightLineColour = "#555";//"#AAFF00"; //"#521A24";
var nodataColour = "#f1f1f1";
var label_yShift = 55; //y-displacement of voronoi city label

var formatDecimalS = d3.format(".2s"); //d3.format(".3n");
var formatDecimalSci = d3.format(".2n");

//Related to dimension selected
var dim, dimUnits; //dimension to colour voronoi map with
var dimExtentDict = {};
dim = d3.select("#cb_label").text(); //dimension for polygon overlay

// Find data range for each dim (to be used for voronoi colour overlay)
d3.csv("data/match_GEA_UITP_CDP2017_adaptedRegions_selectedColumns.csv", function(ghg) {  
  dimExtentDict = {
    "GHG/capita": d3.extent(ghg, function (d) {return +d.total_GHG/+d.Current_population;}),
    "GHGe intensity 2004": d3.extent(ghg, function (d) {return +d["GHGe intensity 2004"];}),
    "GHGe intensity 2009": d3.extent(ghg, function (d) {return +d["GHGe intensity 2009"];}),
    "population": d3.extent(ghg, function (d) {return +d.population;}),
    "population density": d3.extent(ghg, function (d) {return +d["population density"];}),
    "GDP/capita": d3.extent(ghg, function (d) {return +d["GDP/capita"];}),
    "diesel price": d3.extent(ghg, function (d) {return +d["diesel price"]}),
    "gas price": d3.extent(ghg, function (d) {return +d["gas price"]}),
    "HDD 15.5C": d3.extent(ghg, function (d) {return +d["HDD 15.5C"]}),
    "CDD 23C": d3.extent(ghg, function (d) {return +d["CDD 23C"]}),
    "urban ratio": d3.extent(ghg, function (d) {return +d["urban ratio"]}),
    "household size": d3.extent(ghg, function (d) {return +d["household size"]}),
    "commerce index": d3.extent(ghg, function (d) {return +d["commerce index"]})
  }
}); //end d3.csv for match_GEA_UITP_CDP...



var xScale, yScale; //for similarity map positions


//Related to colourbar
var cb_values = [];
var delta, colourmapDim; //colourbar values and colours


// Voronoi and leaflet map variables
// ---------------------------------
var width = 800,
    height = 350; //400;

// padding around the chart where axes will go
var padding = {
  top: 0,
  right: 0,
  bottom: 0,
  left: 0,
};
// inner chart dimensions, where the dots are plotted
var plotAreaWidth = width - padding.left - padding.right;
var plotAreaHeight = height - padding.top - padding.bottom

var pointRadius = 5;

var cityName_array = [];

// ----------------------------------------------------
// Code
// ----------------------------------------------------

d3.select("#infoText")
  .text("Hover over a city area on the world map or on the similarity map to see city statistics.")
  .style("font-size", "14px");

// Radio buttons to select overlay for voronoi polygon cities
d3.select("input[value=\"GHG/capita\"]").property("checked", true); //default
d3.selectAll("input")
      .on("change", change);

function change() {
  d3.select("#cb_label").html("<h4>" + this.value + "</h4>");
  dim = d3.select("#cb_label").text();
  dimExtent = dimExtentDict[dim];

  console.log("dim: ", dim)


  create_colourBar();
  
  // Fill colourbar rects according to new dim
  d3.select("#cb").selectAll("rect")
    .attr("fill", function (d, i) {
      return cb_hex[i];
    });

  // voronoiOverlay();
  voronoiCirclesOverlay(); //aux_fns.js

}

// Select data type for bar chart
d3.select("#barButton")
  .on("click", function() {
    var buttonText = (d3.select(this).text() === "GHG/GDP") ?
                      "GHG/capita" : "GHG/GDP";

    d3.select(this).text(buttonText);
    ghgBarChart();

  });

// // Map reset button
// d3.select("#resetButton")
//     .on("click", resetMap);

// function resetMap() {
//     console.log("resetmap")
// }


// d3.csv("data/Creutzig2014_dataset_wb.csv", function(ghg) {
d3.csv("data/match_GEA_UITP_CDP2017_adaptedRegions_selectedColumns.csv", function(ghg) {
  console.log("ghg read: ", ghg)

  // Similar city voronois
  d3.csv("data/df_Z_dims_country_dfs_truncSVD_gea_uitp_noWaterBd_ncomp5_perplexity40.csv", function(error, vdata) //country column added manually
  // d3.csv("data/df_Z_dims_dfs_truncSVD_gea_uitp_noWaterBd_ncomp5_perplexity40.csv", function(error, vdata)
  {
                if (error) throw error;
    // console.log("vdata: ", vdata)

    //ghg is an array of json objects containing the data in the csv
    //Columns in the csv:
    //['City name',
    // 'city',
    // 'country',
    // 'region',
    // 'Total city-wide emissions, tonnes CO2 ', -> total_GHG
    // 'Increase/Decrease from last year', -> delta_GHG
    // 'Reason for increase/decrease in emissions', -> delta_GHG_reason
    // 'Current population', -> Current_population
    // 'City location', -> City_location
    // 'population',
    // 'population_density',
    // 'gdp_per_cap',
    // 'HDD_15.5C', -> HDD_155C
    // 'CDD_23C', -> CDD_23C
    // 'diesel_price',
    // 'gasoline_price',
    // 'emission_intensity_2004',
    // 'emission_intensity_2009',
    // 'household_size',
    // 'year_household_size',
    // 'water_bounded',
    // 'other_bounded',
    // 'center_of_commerce_index',
    // 'urbanization_ratio']

    // Scales for voronoi polygon centre points
    // use d3.extent to find the min and max values of selected dimension
    console.log("dim after ghg read: ", dim)
    dimExtent = d3.extent(ghg, function (d) {
      if (dim === "GHG/capita") return +d.total_GHG/+d.Current_population;
      else if (dim === "GHGe intensity 2004") return +d["GHGe intensity 2004"];
      else if (dim === "GHGe intensity 2009") return +d["GHGe intensity 2009"];
      else if (dim === "population") return +d.population;
      else if (dim === "population density") return +d["population density"];//+d.pdensity;
      else if (dim === "GDP/capita") return +d["GDP/capita"];
      else if (dim === "diesel price") return +d["diesel price"];//+d.diesel_price;
      else if (dim === "gas price") return +d["gas price"];//+d.gasoline_price;
      else if (dim === "HDD 15.5C") return +d["HDD 15.5C"];
      else if (dim === "CDD 23C") return +d["CDD 23C"];
      else if (dim === "urban ratio") return +d["urban ratio"];
      else if (dim === "commerce index") return +d["commerce index"];
      else if (dim === "household size") return +d["household size"];
    });

    setupData(ghg);
    setup_vData(vdata);
    drawMap();
    ghgBarChart();
    mapSimilarCities(vdata, ghg); //draw similar city voronoi polygons     

  }); // ./d3.tsv similarity voronoi polygon file

}); // ./d3.csv for emissions data

// ----------------------------------------------------
// Functions
// ----------------------------------------------------
// function setupData(ghg)


// d3js World Map
//------------------
function drawMap() {
  // Map reset button
  d3.select("#resetButton")
      .on("click", resetMap);

  //https://bl.ocks.org/mbostock/db6b4335bf1662b413e7968910104f0f
  var zoom = d3.zoom()
    .scaleExtent([1, 40])
    .translateExtent([[-100, -100], [width + 90, height + 100]])
    .on("zoom", zoomed);

  //https://bl.ocks.org/mbostock/3711652
  var mapHeight = 410;

  var options = [
    {name: "Natural Earth", projection: d3.geoNaturalEarth()}
  ];

  options.forEach(function(o) {      
    o.projection.rotate([0, 0]).center([40, 0]);
  });

  var projection = options[0]
              .projection
              .scale(143)
              .translate([width/1.65, height/1.7]);

  var path = d3.geoPath()
      .projection(projection)
      .pointRadius([3]);

  var graticule = d3.geoGraticule();

  var svg = d3.select("#map").append("svg")
      .attr("width", width)
      .attr("height", mapHeight);
     //  .call(d3.zoom().on("zoom", function () {
     //    svg.attr("transform", d3.event.transform)
     // }));

  svg.append("defs").append("path")
    .datum({type: "Sphere"})
    .attr("id", "sphere")
    .attr("d", path);

  svg.append("use")
    .attr("class", "stroke")
    .attr("xlink:href", "#sphere")
    .style("fill", "#fcfcef"); //#e6f3f7"); // "#add8e6"

  svg.append("path")
    .datum(graticule)
    .attr("class", "graticule")
    .attr("d", path);

  // //draw bottom line
  // svg.append("g").selectAll("line")
  //     .data([0])
  //     .enter().append("line")
  //     .attr("class", "line")
  //     .style("stroke", "#000")
  //     .style("stroke-width", "2px")
  //     .attr("x1", 71)
  //     .attr("y1", 350)
  //     .attr("x2", 724)
  //     .attr("y2", 350);  

 

  d3.json("geojson/world_countries.json", function(error, world) {
    if (error) throw error;
   
    d3.json("geojson/cities_edited.geojson", function(error, cities) {
      if (error) throw error;

      //world countries
      svg.append("g")
          .attr("class", "countries")
        .selectAll("path")
          .data(world.features)
        .enter().append("path")
          .attr("d", path)
          .attr("id", function (d) {
            mapName = d.properties.name.replace(/\s/g, '_');
            return "map" + mapName;
          })
          .style("fill", "#2B292E") //#000, "#d9d9d9"
          .style('stroke', '#555')  //#555
          .style('stroke-width', 1.5)
          // tooltips
            .style('stroke-width', 1);
            // .on('mouseover',function (d) {
            //   //tip.show(d);
            //   d3.select(this)
            //     // .style("opacity", 1)
            //     .style("stroke","#CBBF31")
            //     .style("stroke-width",3);
            // })
            // .on('mouseout', function (d) {
            //   // tip.hide(d);
            //   //highlightElements(idName, d.country);
            //   d3.select(this)
            //     // .style("opacity", 0.8)
            //     .style("stroke","white")
            //     .style("stroke-width",0.3);
            // });
      
      // City markers from geojson file     
      svg.selectAll('path')
          .data(cities.features)
          .enter().append('path')
          .attr('d', path)
          .attr("id", function (d, i) {
            return "city" + format_idName(d.id);
          })
          .attr("class", "worldcity")
          .style("fill", function (d) {
            if (data_GHG.find(x => x.city === d.id)) {
              return simregionColourMap[data_GHG.find(x => x.city === d.id).region];
            }
            else {
              if (data_noGHG.find(x => x.city === d.id)) {
                _this = data_noGHG.find(x => x.city === d.id).idName;
                _thisGroup = d3.select("#vcircle" + _this).attr("class");
                return simregionColourMap[_thisGroup];
              }
              else return "none";
            }
          })
          .style("stroke", function (d) {
            if (data_GHG.find(x => x.city === d.id) ||
                 data_noGHG.find(x => x.city === d.id)) return "#555";
            else return "none";  
          })
          .on("mouseover", function (d) {
            highlightElements(format_idName(d.properties.city));
          })
          .on('mouseout', function (d) {
            resetElements();
          });



    }); // ./inner d3.json
  }); // ./outer d3.json
  
  svg.call(zoom);

  function zoomed() {
  
    // path.pointRadius([0.1])
    // console.log("path: ", path.pointRadius())

    svg.attr("transform", d3.event.transform);
    

    // gX.call(xAxis.scale(d3.event.transform.rescaleX(x)));
    // gY.call(yAxis.scale(d3.event.transform.rescaleY(y)));
  }


  function resetMap() {
    svg.transition()
      .duration(750)
      .call(zoom.transform, d3.zoomIdentity);
  } 
  


} // ./drawMap()

function highlightElements(idName) {
  // clear any previous story first
  d3.select("#ghgStory").text("");

  // if (countryName === "United Kingdom") countryName = "England";
  // countryName = countryName.replace(/\s/g, '_');

  //Clear Previous
  //--------------
  resetElements();

  //Highlight Current
  //-----------------
  d3.selectAll(".bar:not(#bar" + idName + ")")
    .style("fill-opacity", 0.3); 

  d3.selectAll(".node:not(#node" + idName + ")")
    .style("fill-opacity", 0.1)
    .style("stroke-opacity", 0.1);
  
  d3.selectAll(".worldcity:not(#city" + idName + ")")
    .style("fill-opacity", 0.1)
    .style("stroke-opacity", 0.1);
  d3.selectAll(".countries").selectAll("path").style("opacity", 0.1);
  d3.select("#city" + idName)
    .attr("stroke", "black")
    .attr("stroke-width", 2);

  // Display stats
  // For data_GHG
  if (data_GHG.find(x => x.idName.includes(idName))) {
    // Highlight country on world map
    // highlightCountry(countryName, idName, data_GHG);

    // Display stats table
    if (data_GHG.find(x => x.idName.includes(idName))) {
      matchCity = data_GHG.find(x => x.idName.includes(idName)).city;
      statsTable(matchCity, data_GHG);
    }

  } //for data_noGHG
  else if (data_noGHG.find(x => x.idName.includes(idName))) {//use data from df_Z
    // Highlight country on world map
    // highlightCountry(countryName, idName, data_noGHG);
    
    // Display statsTable
    matchCity = data_noGHG.find(x => x.idName.includes(idName)).city;
    statsTable(matchCity, data_noGHG);
  }

} // ./highlightElements()

// Update region text when hovering over worldmap city or voronoi polygon
function updateRegionLabel(region) {
  d3.select("#regionLabel" + region).text(regionLabel_dict[region])
    // .style("margin-left", "60px");
}

function mapSimilarCities(vdata, ghg){
  console.log("vdata[0]: ", vdata[0])
  console.log("ghg[0]: ", ghg[0])

  // Convert string to num
  vdata.forEach(function(d) {
    d.x = +d.dim1; //x-coord of point in cluster
    d.y = +d.dim2; //y-coord of point in cluster
  });
  
  // ----------------------------------------------------
  // Variables
  // ----------------------------------------------------
  var svgSimVoronoi = d3.select("#mapSim").select("svg")
      .attr("width", width)
      .attr("height", height);

  // Define the div for the tooltip  
  // http://bl.ocks.org/d3noob/a22c42db65eb00d4e369
  var div = d3.select("#mapSim").append("div")
    .attr("class", "vtooltip")
    .style("opacity", 0);
  
  // tooltip for cluster region label
  var div = d3.select("#mapSim").append("div")
    .attr("class", "rtooltip")
    .style("opacity", 0);
    

  var borderPath = svgSimVoronoi.append("rect")
  .attr("x", 0)
  .attr("y", 0)
  .attr("height", height)
  .attr("width", width)
  .style("stroke", "#555")
  .style("fill", "none")
  .style("stroke-width", 1);    


  create_colourBar();

  // ----------------------------------------------------
  // Scales
  // ----------------------------------------------------
  
  // Scales for voronoi polygon centre points
  // use d3.extent to find the min and max values in the dataset for the domains
  var xextent = d3.extent(vdata, function(d) { return +d.x;} );
  var yextent = d3.extent(vdata, function(d) { return +d.y;} );

  // Scales for voronoi polygons
  xScale = d3.scaleLinear()
        .domain([xextent[0], xextent[1]])
        .range([0, width]);
  yScale = d3.scaleLinear()
        .domain([yextent[0], yextent[1]])
        // .range([height-10*pointRadius, 0]);
        .range([0, height-10*pointRadius]); //reflect along x-axis
  
  // ----------------------------------------------------
  // Voronoi Similarity Polygons
  // ----------------------------------------------------

  // create a Voronoi diagram based on the polygon centres and the scales
  var voronoiDiagram = d3.voronoi()
    .x(d => xScale(d.x))
    .y(d => yScale(d.y))
    .size([plotAreaWidth, plotAreaHeight])(vdata);

  // ----------------------------------------------
  // Draw ellipse around each voronoi cluster 
  // ----------------------------------------------
  addEllipseToSVG("groupNordic", [804,97,78,33], [675,91], "Nordics");
  addEllipseToSVG("groupUSAAusNZ", [685,187,84,45], [518,175], "USA/Aus/NZ");
  addEllipseToSVG("groupAfricaAsia", [398,70,231,73], [97,33], "Africa/Asia");
  addEllipseToSVG("groupEast", [287,124,57,42], [129,128], "Eastern Europe");
  addEllipseToSVG("groupMix", [398,142,50,25], [447,130], "Mix");
  addEllipseToSVG("groupEurope", [213,232,300,89], [122,169], "Europe");

  function addEllipseToSVG(label, ellipse_pos, text_pos, text) {    

    // Display the ellipse outline
    var ellipse = svgSimVoronoi
      .append("g");

    ellipse.append("ellipse")
      // .attr("class", "ellipses " + label)
      .attr("class", label)
      .attr("cx", ellipse_pos[0])
      .attr("cy", ellipse_pos[1])
      .attr("rx", ellipse_pos[2])
      .attr("ry", ellipse_pos[3])
      .attr("transform", function () {
        if (label === "groupEU") return "rotate(5)";
      });

    ellipse.append("text")
      .attr("class", "textLabels")
      // .attr("id", label)
      .attr("dx", text_pos[0])
      .attr("dy", text_pos[1])
      .text(text)
      .on("touchmove mousemove", function () {
        //Fill in selected cluster
        d3.select("ellipse." + label).style("fill", "#e2efed");

        //Show outsider cities
        if (label === "groupNordic" || label === "groupEurope") {
          d3.select("#nodeTextGävle").style("opacity", 1).classed("nodeTextSelected", true);
          d3.select("#nodeTextSkåne_county").style("opacity", 1).classed("nodeTextSelected", true);
          d3.select("#nodeTextHalmstad").style("opacity", 1).classed("nodeTextSelected", true);
          d3.select("#nodeTextCopenhagen").style("opacity", 1).classed("nodeTextSelected", true);
        }
        if (label === "groupEurope") {
          d3.select("#nodeTextKyoto").style("opacity", 1).classed("nodeTextSelected", true);
          d3.select("#nodeTextTokyo").style("opacity", 1).classed("nodeTextSelected", true);
        }
        if (label === "groupUSAAusNZ") {
          d3.select("#nodeTextSingapore").style("opacity", 1).classed("nodeTextSelected", true);
          d3.select("#nodeTextHong_Kong").style("opacity", 1).classed("nodeTextSelected", true);
          d3.select("#nodeTextGraz").style("opacity", 1).classed("nodeTextSelected", true);
        }
        if (label === "groupEast") {
          d3.select("#nodeTextSapporo").style("opacity", 1).classed("nodeTextSelected", true);
          d3.select("#nodeTextIstanbul").style("opacity", 1).classed("nodeTextSelected", true);
        }
        if (label === "groupAfricaAsia") {
          d3.select("#nodeTextMexico_City").style("opacity", 1).classed("nodeTextSelected", true);
          d3.select("#nodeTextBogotá").style("opacity", 1).classed("nodeTextSelected", true);
          d3.select("#nodeTextKyoto").style("opacity", 1).classed("nodeTextSelected", true);
          d3.select("#nodeTextTokyo").style("opacity", 1).classed("nodeTextSelected", true);
          d3.select("#nodeTextSingapore").style("opacity", 1).classed("nodeTextSelected", true);
          d3.select("#nodeTextHong_Kong").style("opacity", 1).classed("nodeTextSelected", true);
          d3.select("#nodeTextSapporo").style("opacity", 1).classed("nodeTextSelected", true);
          d3.select("#nodeTextTel_Aviv").style("opacity", 1).classed("nodeTextSelected", true);
        }

        //Position rtooltip
        d3.select("#mapSim").select("div.rtooltip")
          .style("opacity", 0.8)
          .html(regionLabelTooltip_dict[label])
          .style("left", function (d) {
            if (label === "groupAfricaAsia") return (d3.event.pageX - 110) + "px";
            else if (label === "groupEurope") return (d3.event.pageX + 320) + "px";
            else if (label === "groupEast") return (d3.event.pageX - 200) + "px";
            else return (d3.event.pageX) + "px";
          })
          .style("height", function () {if (label==="groupMix") return "75px";})
          .style("top", function () {
            if (label === "groupEurope") return (d3.event.pageY - 420) + "px";
            else if (label === "groupEast") return (d3.event.pageY - 620) + "px";
            else if (label === "groupNordic") return (d3.event.pageY - 620) + "px";
            else if (label === "groupUSAAusNZ") return (d3.event.pageY - 420) + "px";
            else if (label === "groupAfricaAsia") return (d3.event.pageY - 510) + "px";
            else return (d3.event.pageY - 530) + "px";
          });

        // Colour vcircles by region
        dim = "region";
        fillVoronoiCircles();
      })
      .on("mouseout", function () {
        d3.select("#mapSim").select("div.rtooltip")
          .style("opacity", 0);

        d3.selectAll("ellipse").style("fill", "none");

        d3.selectAll(".nodeTextSelected")
          .style("opacity", 0)
          .classed("nodeTextSelected", false);

        //restore circle colour to original dim
        dim = d3.select("#cb_label").text();
        voronoiCirclesOverlay();
      });
  }

  // ------------------------------------------------------
  // Voronoi polygon centres
  // ------------------------------------------------------
  var circles = svgSimVoronoi
      .append('g')
      .attr('class', 'circles-vcentre');

  var node = circles.selectAll('.data-point')
      .data(vdata)
      .enter().append('g')
      .attr("class", "node")
      // .attr("class", function (d) {
      //   if (nordics.indexOf(d.city) != -1) return "node groupNordic";
      //   else if (latinAmer.indexOf(d.city) != -1) return "node groupLatinAmer";
      //   else if (usaAusNZ.indexOf(d.city) != -1) return "node groupUSAAusNZ";
      //   else if (europe.indexOf(d.city) != -1) return "node groupEurope";
      //   else if (east.indexOf(d.city) != -1) return "node groupEast";
      //   else if (africaAsia.indexOf(d.city) != -1) return "node groupAfricaAsia";
      // })
      .attr("id", function(d) {
        idName = format_idName(d.city);
        return "node" + idName;
      });

  node.append('circle')
      .attr("id", function(d) {
        idName = format_idName(d.city);
        return "vcircle" + idName;
      })
      .attr("class", function (d) {
        if (nordics.indexOf(d.city) != -1) return "groupNordic";
        else if (latinAmer.indexOf(d.city) != -1) return "groupLatinAmer";
        else if (usaAusNZ.indexOf(d.city) != -1) return "groupUSAAusNZ";
        else if (europe.indexOf(d.city) != -1) return "groupEurope";
        else if (east.indexOf(d.city) != -1) return "groupEast";
        else if (africaAsia.indexOf(d.city) != -1) return "groupAfricaAsia";
      })
      .attr('r', pointRadius)
      .attr('cx', d => xScale(d.x))
      .attr('cy', d => yScale(d.y))
      // .attr('fill', d => colorScale(d.y));
      // .attr('fill', '#e9967a');
      .attr('fill', function(d) {
        // if (cityName_array.indexOf(d.city) != -1) return "#555"
        // else return voronoiCircleColour;//'#e9967a';
        matchCity = data_GHG.find(x => x.city === d.city)
        dim = "GHG/capita";
        if (matchCity) {
            return colourmapDim(matchCity[dim]);
        } else return nodataColour; //No GHG data available
      })
      .style("stroke", "#555")
      .on("touchmove mousemove", vcircleMouseover)
      .on("mouseout", function (d) {
        resetElements();
      });

      // Add city label only for outlier cities in cluster
      node.append('text')
        .attr("class", "nodeText")
        .attr("id", function (d) {
          idName = format_idName(d.city);
          return "nodeText" + idName;
        })
        .attr('dx', function(d) {
          //Outsiders in USA/Aus/NZ
          if (d.city === "Hong Kong") return xScale(d.x) - 25;
          else if (d.city === "Singapore") return xScale(d.x) - 63;
          else if (d.city === "Graz") return xScale(d.x) + 9;

          //Outsiders in Europe cluster
          else if (d.city === "Gävle") return xScale(d.x) + 8;
          else if (d.city === "Skåne county") return xScale(d.x) + 6;
          else if (d.city === "Halmstad") return xScale(d.x) + 6;
          else if (d.city === "Copenhagen") return xScale(d.x) + 6;
          else if (d.city === "Kyoto") return xScale(d.x) - 4;
          else if (d.city === "Tokyo") return xScale(d.x) + 6;

          //Outsiders in Eastern Europe cluster
          else if (d.city === "Sapporo") return xScale(d.x) + 8;

          //Outsiders in Mix cluster
          else if (d.city === "Tel Aviv") return xScale(d.x) - 14;

          //Outsiders in Africa/Asia cluster
          else if (d.city === "Mexico City") return xScale(d.x) + 5;
          else if (d.city === "Bogotá") return xScale(d.x) + 6;

          else if (d.city === "Istanbul") return xScale(d.x) + 6;

          else return xScale(d.x);
        })
        .attr('dy', function(d){
          //Outsiders in USA/Aus/NZ
          if (d.city === "Hong Kong") return yScale(d.y) + 15;
          else if (d.city === "Singapore") return yScale(d.y) + 4;

          //Outsiders in Europe cluster
          else if (d.city === "Gävle" || d.city === "Skåne county") return yScale(d.y) + 4;
          else if (d.city === "Halmstad") return yScale(d.y) - 6;
          else if (d.city === "Copenhagen") return yScale(d.y) + 8;
          else if (d.city === "Tokyo") return yScale(d.y) + 3;
          else if (d.city === "Kyoto") return yScale(d.y) - 9;

          //Outsiders in Eastern Europe cluster
          else if (d.city === "Sapporo") return yScale(d.y) + 4;

          //Outsiders in Mix cluster
          else if (d.city === "Tel Aviv") return yScale(d.y) + 16;

          //Outsiders in Africa/Asia cluster
          else if (d.city === "Mexico City") return yScale(d.y) + 9;
          else if (d.city === "Bogotá") return yScale(d.y) + 3;

          else if (d.city === "Istanbul") return yScale(d.y) + 3;

          else return yScale(d.y);
        })
        .text(function(d) {
          if (d.city === "Hong Kong" || d.city === "Singapore" || d.city === "Graz"
             || d.city === "Gävle" || d.city === "Skåne county" || d.city === "Copenhagen"
             || d.city === "Tokyo" || d.city === "Kyoto" || d.city === "Sapporo"
             || d.city === "Tel Aviv" || d.city === "Mexico City" || d.city === "Bogotá"
             || d.city === "Istanbul" || d.city === "Halmstad") {
            return d.city;
          }
        })
        .style("opacity", 0); //turn on only when hovering over cluster text label



} // ./mapSimilarCities

function ghgBarChart() {
  // Remove any previous bar chart
  d3.select("#ghgBarChart").select("svg").remove();
  
  // Colour mapping for dim = GHG_cap
  this_dim = (d3.select("#barButton").text() === "GHG/GDP") ?
                      "GHG/capita" : "GHG/GDP";
  d3.select("#regionLabel").text(this_dim + " " + dimUnits[this_dim]
    + " emissions grouped by world region");

  //https://bl.ocks.org/seemantk/ec245e1f4e824e685982dd5d3fbb2fcc
  var margin = {top: 20, right: 20, bottom: 70, left: 40},
      width = 700 - margin.left - margin.right,
      height = 300 - margin.top - margin.bottom;

  // Extract data by region
  ghg_europe = sortByRegion("groupEurope");
  ghg_usaAusNZ = sortByRegion("groupUSAAusNZ");
  // ghg_africaAsia = sortByRegion("groupAfricaAsia");
  //ghg_africa = sortByRegion("groupAfrica");
  //ghg_asia = sortByRegion("groupAsia");
  ghg_east = sortByRegion("groupEast");
  ghg_latinAmer = sortByRegion("groupLatinAmer");
  ghg_nordic = sortByRegion("groupNordic");

  // Sort columns in each region
  ghg_europe.sort((a, b) => d3.descending(a[this_dim], b[this_dim]));
  ghg_usaAusNZ.sort((a, b) => d3.descending(a[this_dim], b[this_dim]));
  // ghg_africaAsia.sort((a, b) => d3.descending(a[this_dim], b[this_dim]));
  //ghg_africa.sort((a, b) => d3.descending(a[this_dim], b[this_dim]));
  //ghg_asia.sort((a, b) => d3.descending(a[this_dim], b[this_dim]));
  ghg_east.sort((a, b) => d3.descending(a[this_dim], b[this_dim]));
  ghg_nordic.sort((a, b) => d3.descending(a[this_dim], b[this_dim]));
  ghg_latinAmer.sort((a, b) => d3.descending(a[this_dim], b[this_dim]));

  //Separate Asia and Africa by hand for now
  var ghg_asia = [], ghg_africa = [];
  var africaCities = ["Cape Town", "Johannesburg"];
  var asiaCities = ["Tokyo", "Seoul", "Hong Kong"];
  data_GHG.forEach(function (d) {
    if (asiaCities.indexOf(d.city) != -1 ) ghg_asia.push(d);
    else if (africaCities.indexOf(d.city) != -1 ) ghg_africa.push(d);
  });
  ghg_africa.sort((a, b) => d3.descending(a[this_dim], b[this_dim]));
  ghg_asia.sort((a, b) => d3.descending(a[this_dim], b[this_dim]));
  
  var ghg_ordered = ghg_usaAusNZ
      .concat([{ "city":"gap",  "region":"groupUSAAusNZ",
                 "GHG/capita":0, "GHG/GDP": 0 }])
      .concat(ghg_east)
      .concat([{ "city":"gap3", "region":"groupEast", "GHG/capita":0,
                 "GHG/GDP": 0 }])
      .concat(ghg_europe)
      .concat([{ "city":"gap2", "region":"groupEurope", "GHG/capita":0,
                 "GHG/GDP": 0 }])
      .concat(ghg_nordic)
      .concat([{ "city":"gap6", "region":"groupNordic", "GHG/capita":0,
                 "GHG/GDP": 0 }])      
      .concat(ghg_asia)
      .concat(ghg_africa)
      .concat([{ "city":"gap4", "region":"groupAfricaAsia", "GHG/capita":0,
                 "GHG/GDP": 0 }])
      .concat(ghg_latinAmer);  

  var x = d3.scaleBand()
            .rangeRound([0, width], .1)
            .paddingInner(0.1);

  var y = d3.scaleLinear()
            .range([height, 0]);

  var xAxis = d3.axisBottom()
    .scale(x);

  var yAxis = d3.axisLeft()
    .scale(y)
    // .ticks(10, "%");
    .ticks(10);

  var svgBarChart = d3.select("#ghgBarChart").append("svg").attr("class", "barSVG")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  var barRegionLabel = svgBarChart.append("g")
          .append("text")
          .attr("class", "barChartRegionLabel");

  x.domain(ghg_ordered.map(function (d) {
    return d.city;
  }));
  y.domain([0, d3.max(ghg_ordered, function(d) { return d[this_dim]; })]);

  svgBarChart.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis)
      .selectAll("text")
      .attr("id", function (d) {
        idName = format_idName(d);
        return "tick" + idName;
      })
      .attr("y", -3)
      .attr("x", 7)
      .attr("dy", "12px")
      .attr("transform", "rotate(45)")
      .style("text-anchor", "start")
      .style("fill", function (d) {
        if (d.includes("gap")) return "#fff";
        else return "#636363";
      });

  svgBarChart.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", -33)  //6
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      // .text("GHG/capita [tCO2]")
      .text(this_dim + " " + dimUnits[this_dim])
      .style("fill", "#636363");

  svgBarChart.append("g").selectAll(".bar")
      .data(ghg_ordered)
      .enter().append("rect")
      .attr("class", "bar")
      .attr("id", function (d) {
        idName = format_idName(d.city);
        return "bar" + idName;
      })
      .attr("x", function (d) { return x(d.city); })
      .attr("width", x.bandwidth())
      .attr("y", function (d, i) { return y(d[this_dim]); })
      .attr("height", function(d) { return height - y(d[this_dim]); })
      .attr("fill", function (d) {
        return simregionColourMap[d.region];
      })
      .on("touchmove mousemove", function (d) {

        // Erase left-over tooltip from voronoi polygon exploration
        d3.select("#mapSim").select("div.vtooltip").style("opacity", 0);

        idName = format_idName(d.city);
        // highlightElements(idName, d.country);
        highlightElements(idName);
        
        // Enlarge city label of selected bar
        d3.select("#tick" + idName).style("font-size", "16px");

        // Dim opacity of all city labels except current city
        d3.select("#ghgBarChart").select(".x.axis")
          .selectAll("text:not(#tick" + idName + ")")
          .style("opacity", 0.2);

        // Display region in text label
        updateRegionLabel(d.region);
        var region = d.region;
        barRegionLabel.html(regionLabel_dict[d.region])
          .attr("dx", function () {
            if (region === "groupUSAAusNZ") return "85";
            else if (region === "groupEurope") return "318";
            else if (region === "groupAfricaAsia") return "495";
            else if (region === "groupEast") return "194";
            else if (region === "groupNordic") return "441";
            else if (region === "groupLatinAmer") return "554";
          })
          .attr("dy", function () {
            if (region === "groupUSAAusNZ") return "65";
            else if (region === "groupEurope") return "131";
            else if (region === "groupAfricaAsia") return "80";
            else if (region === "groupEast") return "110";
            else if (region === "groupNordic") return "158";
            else if (region === "groupLatinAmer") return "70";
          });

      })
      .on("mouseout", function (d) {
        idName = format_idName(d.city);
        d3.select("#tick" + idName).style("font-size", "10px");

        d3.select("#ghgBarChart").select(".x.axis")
          .selectAll("text")
          .style("opacity", 1);

        resetElements();
      });

      // Hide x-axis tick mark for gap bar
      d3.selectAll("#ghgBarChart").select(".x.axis").selectAll(".tick")
      .style("opacity", function (d) {
        if (d.includes("gap")) return 0;
      });

      // Plot regional avg emissions [tCO2/capita] as a line
      // over each bar group
      var regionalVar = this_dim === "GHG/capita" ? regionalAvgs : regionalAvgs_GDP;
      svgBarChart.append("g").selectAll("line")
        .data(Object.values(regionalVar))
        .enter().append("line")
        .attr("class", "line")
        .style("stroke", "#c5e0dc")
        .style("stroke-width", "2px")
        .attr("x1", function (d, i) {
          if (this_dim === "GHG/capita") {
            if (i === 0) return x("Melbourne");
            else if (i === 1) return x("Ljubljana");
            else if (i === 2) return x("Hong Kong");
            else if (i === 3) return x("Cape Town");
            else if (i === 4) return x("Rio de Janeiro");
          } else {
            if (i === 0) return x("Melbourne");
            else if (i === 1) return x("Ljubljana");
            else if (i === 2) return x("Seoul");
            else if (i === 3) return x("Cape Town");
            else if (i === 4) return x("Bogotá");
          }
        })
        .attr("y1", function (d, i) { return y(d); })
        .attr("x2", function (d, i) {
          if (i === 0) return x("gap");
          else if (i === 1) return x("gap6");
          else if (i === 2) return x("Cape Town");
          else if (i === 3) return x("gap4");
          else if (i === 4) return x("Brasília") + 9;
        })
        .attr("y2", function (d, i) { return y(d); });
        
        // Legend line + text
        regionalLine = svgBarChart.append("g");
        regionalLine.selectAll("line")
            .data([0])
            .enter().append("line")
            .attr("class", "line")
            .style("stroke", "#c5e0dc")
            .style("stroke-width", "2px")
            .attr("x1", 520)
            .attr("y1", 40)
            .attr("x2", 536)
            .attr("y2", 40);

        regionalLine.append("text")
          .attr("class", "textLabels")
          .attr("dx", 352)
          .attr("dy", 43)
          .text("avg for countries in region");

} // ./fn ghgBarChart()

// //----------------------------------------------
// // Functions for similar cities voronoi map
// //----------------------------------------------

// function create_colourBar() in aux_fns.js
// function dim_colourMapping(dim) in aux_fns.js

function statsTable(matchCity, dataObj) {
  
  // Table columns
  var columns = ['Dimension', 'Value'];

  // Table rows minus emission change info
  cityArray_columns = Object.keys(dataObj[0]);
  cityArray_columns.splice(cityArray_columns.indexOf("city"), 1);
  cityArray_columns.splice(cityArray_columns.indexOf("idName"), 1);
  cityArray_columns.splice(cityArray_columns.indexOf("delta_GHG"), 1);
  cityArray_columns.splice(cityArray_columns.indexOf("delta_GHG_reason"), 1);

  // Stats for highlighted city
  cityArray = dataObj.filter(x => x.city === matchCity);

  // Display info on changes in GHG emissions in div below table
  d3.select("#ghgTable").text(matchCity + " GHG emissions").attr("class", "h3");

  var deltaText = cityArray.length === 0 ? "N/A" : cityArray[0].delta_GHG;
  var deltaReasonText = cityArray.length === 0 ? "N/A" : cityArray[0].delta_GHG_reason;
  if (!deltaText) deltaText = "N/A";
  if (!deltaReasonText) deltaReasonText = "N/A";

  d3.select("#ghgDelta")
    .text("Change from last year: " + deltaText);
  d3.select("#ghgDeltaReason")
    .text("Reason: " + deltaReasonText);
  
  if (matchCity === "Hong Kong") {  
    d3.select("#ghgStory")
      .html("<b>" + "Story: " + "</b><br>" + "Hong Kong is most similar to cities in the North American/Australian cluster rather than cities in its region." + "<br>" +
        "Although Hong Kong has a similar GDP/capita as other OECD cities (e.g. the Nordics and Europe), the diesel and gas prices are much lower in this cluster." + "<br>" +
        "Click on the radio buttons below the Similarity Map to explore and compare city characteristics.");
  } else if (matchCity === "Melbourne") {
    d3.select("#ghgStory")
      .html("<b>" + "Story: " + "</b><br>" + "Melbourne has the highest GHG emissions per capita than any other city in this database. " + "<br>" +
        "However, the characteristics of Melbourne are quite similar to other cities in its cluster, as you can see by clicking on the radio buttons below the Similarity Map." + "<br>" +
        "This suggests that there are other important city characteristics beyond the 10 we have used that are necessary to understand the factors driving the GHG emissions of a city.");
  }


  // Create stats table
  // ------------------
  d3.select("#displayStats").text(matchCity).style("font-size", "26px");
  var table = d3.select("#displayStats")//.select('#dimTable')
                .append('table');

  var thead = table.append('thead')
  var tbody = table.append('tbody');

  // append the header row
  thead.append('tr')
    .selectAll('th')
    .data(columns).enter()
    .append('th');
  
  // Rearrange object into 2D array  
  items = cityArray_columns.map(function(_) {
    if (cityArray.length != 0) return [ _, cityArray[0][_] ];
    else return [ _, "N/A" ];
  });
  

  // create a row for each object in the data
  var rows = tbody.selectAll('tr')
    .data(items)
    .enter()
    .append('tr');


  // create a cell in each row for each column
  var cells = rows.selectAll('td')
    .data(function (row) {
      return columns.map(function (column) {
        if (cityArray.length != 0) return {column: row[0], value: row[1]};
        else return {column: row[0], value: 0};
      });
    })
    .enter()
    .append('td')
      .text(function (d, i) {
        // console.log("statsTable d: ", d)
        return i === 0 ? 
          //column 1 display for i = 0
          d.column :
          ( typeof d.value === "string" ?
            (d.column === "region" ? regionLabel_dict[d.value] : 
                                d.value + " " + dimUnits[d.column])
                : (d.value < 1 ? formatDecimalSci(d.value) + " " + dimUnits[d.column] : formatDecimalS(d.value) + " " + dimUnits[d.column] )
          );
      });


  return table;

}

</script>
</body>
</html>